name: DAST - OWASP ZAP against local app (daily)

on:
  schedule:
    - cron: "0 1 * * *" # daily 01:00 UTC
  workflow_dispatch: {}

jobs:
  zap_dast:
    runs-on: ubuntu-latest

    env:
      BOOT_MODULE: "application"
      APP_URL: "http://localhost:8888"
      KEYSTORE_DIR: "${{ github.workspace }}/keystore"
      KEYSTORE_PASSWORD: "changeit"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 25
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "25"
          cache: "maven"

      - name: (Optional) Show realm file exists
        run: |
          ls -la acceptance/src/test/resources/keycloak/my-stuff.realm.json

      - name: Maven build + acceptance tests
        run: mvn -B clean verify --file pom.xml -Dgroups=acceptanceTest

      - name: Start Keycloak via docker compose
        run: docker compose -f docker-compose.yaml up -d

      - name: Wait for Keycloak realm (OIDC discovery)
        run: |
          set -e
          URL="https://localhost:8443/realms/my-stuff/.well-known/openid-configuration"
          for i in {1..120}; do
            if curl -kfsS "$URL" >/dev/null; then
              echo "Realm is imported and OIDC discovery is reachable."
              exit 0
            fi
            sleep 2
          done
          echo "Realm import not ready in time."
          docker compose -f docker-compose.yaml logs --no-color keycloak | tail -n 300 || true
          exit 1

      - name: Package Spring Boot app (reactor build)
        run: mvn -B -DskipTests -pl "${BOOT_MODULE}" -am package

      - name: Start Spring Boot (background, java -jar)
        run: |
          set -e
          JAR_PATH="$(ls -1 ${BOOT_MODULE}/target/*.jar | grep -v 'original-' | head -n 1)"
          echo "Starting ${JAR_PATH}"

          nohup java \
            -Djavax.net.ssl.keyStore=${KEYSTORE_DIR}/cacerts \
            -Djavax.net.ssl.keyStorePassword=${KEYSTORE_PASSWORD} \
            -Djavax.net.ssl.trustStore=${KEYSTORE_DIR}/cacerts \
            -Djavax.net.ssl.trustStorePassword=${KEYSTORE_PASSWORD} \
            -jar "${JAR_PATH}" \
            --server.port=8888 \
            > app.log 2>&1 &

      - name: Wait for app to be ready
        run: |
          set -e
          echo "Waiting for ${APP_URL} ..."
          for i in {1..120}; do
            if curl -fsS "${APP_URL}" >/dev/null; then
              echo "App is up."
              exit 0
            fi
            sleep 1
          done
          echo "App did not become ready in time."
          echo "---- app.log (tail) ----"
          tail -n 250 app.log || true
          exit 1

      - name: OWASP ZAP Baseline Scan
        run: |
          mkdir -p zap-reports

          RUN_UID=$(id -u)
          RUN_GID=$(id -g)

          docker pull zaproxy/zap-stable
          docker run --rm --network host \
            --user "${RUN_UID}:${RUN_GID}" \
            -v "${PWD}/zap-reports:/zap/wrk:rw" \
            -v "${PWD}/zap-reports:/home/zap:rw" \
            zaproxy/zap-stable \
            zap-baseline.py \
              -t "${APP_URL}" \
              -r zap-baseline-report.html \
              -J zap-baseline-report.json \
              -w zap-baseline-warn.md \
              || true

      - name: Upload ZAP reports
        uses: actions/upload-artifact@v4
        with:
          name: zap-reports
          path: zap-reports

      - name: Upload app log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: app-log
          path: app.log
          if-no-files-found: ignore
